---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r utils}
source("R/methylation_R_utils.R")

library(tidyverse)
library(bsseq)
library(GenomicRanges)
library(BiocParallel)

p <- MulticoreParam(workers = 40, progressbar = T)
```

#### Read
```{r}

# gp5d_meth <- read.bismark("/data/kzkarttu/nanopore/GP5D/methylation/methylation_calls.GP5D.raw.cpg.mfreq.txt.gz")
# gp5d_inh_meth <- read.modkit("/data/kzkarttu/projects/Patel_2024_revision/data/Nanopore/GP5d_DNMTi_HDACi/methylation/GP5d_DNMTi_HDACi_bedMethyl_no_GCG.bed.gz")
# gp5d_meth_comb <- bsseq::combine(gp5d_meth, gp5d_inh_meth)

# gp5d_meth_comb_smooth <- BSmooth(gp5d_meth_comb, BPPARAM = p)
# saveRDS(gp5d_meth_comb_smooth, "data/bsmooth/GP5d_WT_inh_CpG_bsmoothed.rds")
gp5d_meth_comb_smooth <- readRDS("data/bsmooth/GP5d_WT_inh_CpG_bsmoothed.rds")

# testasdasd
```

```{r import_data}
ltr12c_loci <- read_tsv("data/LTR12C/LTR12C_DNMT_HDAC_Up_bothstrand_GP5d.bed", col_names = c("seqnames", "start", "end", "name", "width", "strand"))
ltr12c_tbx <- paste0(ltr12c_loci$seqnames, ":", ltr12c_loci$start, "-", ltr12c_loci$end)

bedmethyl_col_names <- c("seqnames", "start", "end", "base", "score", "strand", "start_pos", "end_pos", "color", "n_valid_cov", "frac_mod", "n_mod", "n_canonical", "n_other_mod", "n_del", "n_fail", "n_diff", "n_nocall")

GP5d_inh <- tibble(tabix(ltr12c_tbx, "data/Nanopore/GP5d_DNMTi_HDACi/methylation/GP5d_DNMTi_HDACi_bedMethyl.bed.gz")) %>%
  rename_with(~bedmethyl_col_names)

gcg_pos <- read_tsv("data/Nanopore/GP5d_DNMTi_HDACi/methylation/gcg_motifs.bed", col_names = bedmethyl_col_names[1:6])

getMeth(gp5d_meth_comb_smooth, regions = , type = "smooth")
```



```{r}
ovls <- findOverlaps(GRanges(GP5d_inh), GRanges(ltr12c_loci))

GP5d_inh %>%
  bind_cols(., ltr12c_loci[subjectHits(ovls), ] %>% rename_with(~ paste0("ltr12c_", colnames(ltr12c_loci))))
```
